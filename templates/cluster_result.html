<!DOCTYPE html>
<html>
<head>
    <title>Clustering Results - {{ market.upper() }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
        }
        h1 { text-align: center; color: #2c3e50; }
        .summary { text-align: center; color: #555; margin-bottom: 20px; }
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 5px solid #667eea;
            border-radius: 10px;
            padding: 20px;
        }
        .metric-card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .metric-desc {
            font-size: 0.85em;
            color: #555;
            line-height: 1.5;
        }
        .cluster-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .stock-item {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: white;
            border-radius: 15px;
            border: 1px solid #ddd;
        }
        canvas { max-height: 500px; margin-bottom: 20px; }
    </style>
</head>

<body>
<div class="container">

<h1>üìä Clustering Results</h1>

<div class="summary">
    Market: <strong>{{ market.upper() }}</strong><br>
    Method: <strong>{{ result.method.upper() }}</strong> | K = <strong>{{ result.optimal_k }}</strong>
</div>

<hr>

{% if result.error %}
    <p style="color:red;text-align:center">{{ result.error }}</p>
{% else %}

<!-- Evaluation Metrics -->
<div class="chart-section">
    <h2>üìä Clustering Quality Metrics</h2>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Silhouette Score</h3>
            <div class="metric-value">
                {% if result.metrics.silhouette_score %}
                    {{ "%.4f" | format(result.metrics.silhouette_score) }}
                {% else %}
                    N/A
                {% endif %}
            </div>
            <div class="metric-desc">
                <strong>Range:</strong> -1 to 1<br>
                <strong>‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ 1 = ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ</strong><br>
                ‚Ä¢ > 0.7 = Excellent<br>
                ‚Ä¢ 0.5-0.7 = Good<br>
                ‚Ä¢ 0.25-0.5 = Fair<br>
                ‚Ä¢ < 0.25 = Poor
            </div>
        </div>

        <div class="metric-card" style="border-left-color: #e74c3c;">
            <h3>Davies-Bouldin Index</h3>
            <div class="metric-value">
                {% if result.metrics.davies_bouldin_index %}
                    {{ "%.4f" | format(result.metrics.davies_bouldin_index) }}
                {% else %}
                    N/A
                {% endif %}
            </div>
            <div class="metric-desc">
                <strong>Range:</strong> 0 to ‚àû<br>
                <strong>‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ 0 = ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ</strong><br>
                ‚Ä¢ < 1.0 = Excellent<br>
                ‚Ä¢ 1.0-2.0 = Good<br>
                ‚Ä¢ > 2.0 = Poor
            </div>
        </div>

        <div class="metric-card" style="border-left-color: #2ecc71;">
            <h3>Number of Clusters</h3>
            <div class="metric-value">K = {{ result.optimal_k }}</div>
            <div class="metric-desc">
                Selected from Elbow Method
            </div>
        </div>
    </div>
</div>

<!-- PCA Scatter Plot -->
<div class="chart-section">
    <h2>üó∫Ô∏è PCA Visualization</h2>
    <canvas id="scatterChart"></canvas>
</div>

<!-- Cluster Assignments -->
<h2>üìã Cluster Assignments</h2>

{% for cluster_id, stats in result.cluster_stats.items() %}
<div class="cluster-section">
    <h3>Cluster {{ cluster_id + 1 }} ({{ stats.count }} cryptos)</h3>

    {% for a in result.assignments %}
        {% if a.cluster == cluster_id %}
            <span class="stock-item">
                {{ a.crypto_id }} <small>({{ a.category }})</small>
            </span>
        {% endif %}
    {% endfor %}
</div>
{% endfor %}

<div style="text-align: center; margin-top: 30px;">
    <a href="/cluster" style="padding: 12px 24px; background: #95a5a6; color: white; text-decoration: none; border-radius: 8px;">‚Üê Back to Market Selection</a>
</div>

{% endif %}
</div>

<script>
/* ===== PCA SCATTER ===== */
{% if result.viz_pca %}
(function() {
    const pca = {{ result.viz_pca | tojson }};
    const colors = ["#3498db","#e74c3c","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e"];

    if (pca && pca.x && pca.y && pca.labels) {
        const datasets = [];
        const uniqueLabels = [...new Set(pca.labels)];
        
        uniqueLabels.forEach(c => {
            const data = pca.x.map((x, i) => 
                pca.labels[i] === c ? {x: x, y: pca.y[i]} : null
            ).filter(v => v !== null);
            
            datasets.push({
                label: "Cluster " + (c + 1),
                data: data,
                backgroundColor: colors[c % colors.length],
                pointRadius: 6,
                pointHoverRadius: 8
            });
        });

        const ctx = document.getElementById("scatterChart");
        if (ctx) {
            new Chart(ctx, {
                type: "scatter",
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { position: "top" },
                        title: {
                            display: true,
                            text: 'PCA 2D Projection of Clusters'
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: "PCA Component 1" }},
                        y: { title: { display: true, text: "PCA Component 2" }}
                    }
                }
            });
        }
    }
})();
{% endif %}
</script>

</body>
</html>
